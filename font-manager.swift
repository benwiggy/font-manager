#!/usr/bin/swift

// Command Line Tool to register and unregister (enable/disable) fonts on macOS.
// Fonts can be registered from any location. They do not need to be in the 
// standard font folders, e.g. /Library/Fonts.

// This script was generated by Code CoPilot AI...!!!

// v1.2. Now lists all registered fonts outside the standard font folders,
// giving their filepath.

import Foundation
import CoreText
import AppKit

enum FontAction: String {
    case register = "register"
    case unregister = "unregister"
    case list = "list"
    case listExt = "list-ext"
}

func registerFont(withPath path: String) -> Bool {
    let fontURL = URL(fileURLWithPath: path)
    let fontURLs = [fontURL] as CFArray

    var registrationSuccessful = true
    CTFontManagerRegisterFontURLs(fontURLs, .persistent, true) { (urls, finished) -> Bool in
        let errorCount = CFArrayGetCount(urls)
        if errorCount > 0 {
            for i in 0..<errorCount {
                if let error = unsafeBitCast(CFArrayGetValueAtIndex(urls, i), to: CFError.self) as CFError? {
                    let errorDescription = CFErrorCopyDescription(error) as String
                    print("Failed to register font: \(errorDescription)")
                    registrationSuccessful = false
                }
            }
        }
        return finished
    }

    if registrationSuccessful {
        print("Successfully registered font at path: \(path)")
    }
    return registrationSuccessful
}

func unregisterFont(withPath path: String) -> Bool {
    let fontURL = URL(fileURLWithPath: path)
    let fontURLs = [fontURL] as CFArray

    var unregistrationSuccessful = true
    CTFontManagerUnregisterFontURLs(fontURLs, .persistent) { (urls, finished) -> Bool in
        let errorCount = CFArrayGetCount(urls)
        if errorCount > 0 {
            for i in 0..<errorCount {
                if let error = unsafeBitCast(CFArrayGetValueAtIndex(urls, i), to: CFError.self) as CFError? {
                    let errorDescription = CFErrorCopyDescription(error) as String
                    print("Failed to unregister font: \(errorDescription)")
                    unregistrationSuccessful = false
                }
            }
        }
        return finished
    }

    if unregistrationSuccessful {
        print("Successfully unregistered font at path: \(path)")
    }
    return unregistrationSuccessful
}

func listInstalledFonts() {
    let fontManager = NSFontManager.shared
    let fontFamilies = fontManager.availableFontFamilies

    print("Installed fonts:")
    for family in fontFamilies {
        print("\n\(family)")
        if let fontNames = fontManager.availableMembers(ofFontFamily: family) {
            for font in fontNames {
                if let fontName = font.first as? String {
                    print("\t\(fontName)")
                }
            }
        }
    }
}

func isNonStandardLocation(fontURL: URL) -> Bool {
    let standardPaths = [
        "/System/Library/Fonts",
        "/Library/Fonts",
        "\(NSHomeDirectory())/Library/Fonts"
    ]
    
    for path in standardPaths {
        if fontURL.path.hasPrefix(path) {
            return false
        }
    }
    return true
}

func listNonStandardLocationFonts() {
    let fontManager = NSFontManager.shared
    let fontFamilies = fontManager.availableFontFamilies

    var nonStandardFonts = [(String, String, String)]() // Tuple of (Font Family, PostScript Name, File Path)

    for family in fontFamilies {
        if let fontNames = fontManager.availableMembers(ofFontFamily: family) {
            for font in fontNames {
                if let fontName = font.first as? String {
                    let ctFont = CTFontCreateWithName(fontName as CFString, 0.0, nil)
                    if let postScriptName = CTFontCopyPostScriptName(ctFont) as String?,
                       let fontURL = CTFontDescriptorCopyAttribute(CTFontCopyFontDescriptor(ctFont), kCTFontURLAttribute) as? URL,
                       isNonStandardLocation(fontURL: fontURL) {
                        nonStandardFonts.append((family, postScriptName, fontURL.path))
                    }
                }
            }
        }
    }
    
    if nonStandardFonts.isEmpty {
        print("No fonts found in non-standard locations.")
    } else {
        print("Activated fonts in non-standard locations:")
        
        // Sort the fonts alphabetically by font family and then by PostScript name
        nonStandardFonts.sort { $0.0 < $1.0 || ($0.0 == $1.0 && $0.1 < $1.1) }
        
        var currentFamily: String?
        for (family, postScriptName, path) in nonStandardFonts {
            if currentFamily != family {
                print("\n\(family)")
                currentFamily = family
            }
            print("\t\(postScriptName)\t\(path)")
        }
    }
}

func printUsage() {
    print("Usage: font-manager.swift [register|unregister|list|list-ext] /path/to/font.ttf")
}

// Main execution
let arguments = CommandLine.arguments

if arguments.count < 2 || (arguments.count != 3 && arguments[1] != "list" && arguments[1] != "list-ext") {
    printUsage()
    exit(1)
}

let action = arguments[1]
let fontPath = arguments.count == 3 ? arguments[2] : nil

guard let fontAction = FontAction(rawValue: action) else {
    printUsage()
    exit(1)
}

let result: Bool

switch fontAction {
case .register:
    guard let fontPath = fontPath else {
        printUsage()
        exit(1)
    }
    // Check if the font file exists
    let fileManager = FileManager.default
    guard fileManager.fileExists(atPath: fontPath) else {
        print("Font file not found at path: \(fontPath)")
        exit(1)
    }

    // Check if the font file has the correct permissions
    do {
        let attributes = try fileManager.attributesOfItem(atPath: fontPath)
        if let permissions = attributes[.posixPermissions] as? NSNumber {
            let filePermissions = permissions.uint16Value
            let readable = (filePermissions & S_IRUSR != 0) && (filePermissions & S_IRGRP != 0) && (filePermissions & S_IROTH != 0)
            if !readable {
                print("Font file at path: \(fontPath) does not have read permissions for all users.")
                exit(1)
            }
        }
    } catch {
        print("Failed to get attributes of font file at path: \(fontPath), error: \(error)")
        exit(1)
    }

    result = registerFont(withPath: fontPath)
case .unregister:
    guard let fontPath = fontPath else {
        printUsage()
        exit(1)
    }
    result = unregisterFont(withPath: fontPath)
case .list:
    listInstalledFonts()
    exit(0)
case .listExt:
    listNonStandardLocationFonts()
    exit(0)
}

if result {
    exit(0)
} else {
    exit(1)
}
